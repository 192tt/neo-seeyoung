<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æ™ºæ…§å…»è€ - AIå¢å¼ºç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body { margin: 0; background: #0b0f19; color: #fff; font-family: 'Microsoft YaHei'; overflow: hidden; }
        #main { width: 100vw; height: 100vh; }

        /* å·¦ä¾§æ§åˆ¶å° */
        #controls {
            position: absolute; top: 20px; left: 20px; width: 320px;
            background: rgba(20, 26, 35, 0.95); border: 1px solid #334155;
            border-radius: 12px; padding: 20px; z-index: 100;
            box-shadow: 0 4px 20px rgba(0,0,0,0.6);
            backdrop-filter: blur(10px);
        }
        .ctrl-group { margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 15px; }
        .ctrl-title { color: #00d2ff; font-size: 14px; margin-bottom: 10px; font-weight: bold; }
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .btn-full { width: 100%; margin-top: 5px; }
        button { background: #1e293b; border: 1px solid #475569; color: #e2e8f0; padding: 8px; border-radius: 6px; cursor: pointer; font-size: 12px; transition: 0.2s; }
        button:hover { background: #00d2ff; color: #000; border-color: #00d2ff; }
        button.active { background: #52c41a; color: #fff; border-color: #52c41a; font-weight: bold; }
        button.disabled { opacity: 0.3; cursor: not-allowed; }
        .action-btn { font-weight: bold; border: 1px dashed #666; }
        .action-btn:hover { background: #fbbf24; color: #000; border-color: #fbbf24; }
        input[type=text] { width: 68%; padding: 8px; background: #0f172a; border: 1px solid #334155; color: #fff; border-radius: 4px; outline: none; }
        input[type=range] { width: 100%; cursor: pointer; accent-color: #00d2ff; }
        #search-status { display: none; color: #fbbf24; font-size: 12px; text-align: center; margin-top: 8px; background: rgba(251, 191, 36, 0.1); padding: 5px; border-radius: 4px; }

        /* === è¯¦æƒ…é¢æ¿ç²¾ä¿® === */
        #details-panel {
            position: absolute; top: 20px; right: 20px; width: 420px; /* å†ç¨å¾®åŠ å®½ä¸€ç‚¹ä»¥å®¹çº³åˆ—è¡¨ */
            background: rgba(15, 23, 42, 0.98); border: 1px solid #1e293b;
            border-left: 3px solid #00d2ff; border-radius: 12px;
            z-index: 100; display: none; max-height: 90vh; overflow-y: auto;
            box-shadow: -10px 10px 30px rgba(0,0,0,0.8);
        }
        #details-panel::-webkit-scrollbar { width: 6px; }
        #details-panel::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }

        .close-btn { position: absolute; top: 12px; right: 12px; width: 28px; height: 28px; background: rgba(255,255,255,0.1); border: none; border-radius: 50%; color: #fff; cursor: pointer; font-size:16px; display: flex; align-items: center; justify-content: center; transition:0.2s;}
        .close-btn:hover { background: #ff4d4f; transform: rotate(90deg); }

        .d-header { padding: 25px 25px 15px 25px; border-bottom: 1px solid #334155; background: linear-gradient(to bottom, #1e293b, rgba(30, 41, 59, 0)); }
        .d-name { font-size: 22px; color: #fff; font-weight: bold; padding-right: 30px; line-height: 1.4; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }

        .code-wrapper { margin-top: 12px; display: flex; gap: 10px; }
        .code-box { flex: 1; background: rgba(0,0,0,0.4); padding: 8px 12px; border-radius: 6px; border: 1px dashed #475569; }
        .d-code { font-family: 'Consolas', monospace; color: #fbbf24; font-size: 15px; font-weight: bold; }
        .d-code-desc { font-size: 10px; color: #94a3b8; margin-top: 2px; }

        .d-body { padding: 20px 25px; }
        .tag-cloud { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 20px; }
        .tag { background: rgba(6, 182, 212, 0.15); color: #22d3ee; padding: 4px 10px; border-radius: 4px; font-size: 11px; border: 1px solid rgba(6, 182, 212, 0.3); white-space: nowrap;}

        .info-list { background: #0f172a; padding: 5px; border-radius: 8px; border: 1px solid #334155; margin-bottom: 20px; }
        .info-row { display: flex; padding: 8px 10px; border-bottom: 1px solid #1e293b; font-size: 13px; align-items: baseline; }
        .info-row:last-child { border-bottom: none; }
        .info-k { width: 70px; color: #64748b; font-size: 12px; flex-shrink: 0; }
        .info-v { color: #e2e8f0; font-weight: 500; word-break: break-all; line-height: 1.5; }
        .highlight { color: #fff; font-weight: bold; }

        .section-box { margin-bottom: 20px; }
        .section-title { font-size: 14px; color: #00d2ff; margin-bottom: 10px; font-weight: bold; display: flex; align-items: center; border-left: 3px solid #00d2ff; padding-left: 10px; background: linear-gradient(90deg, rgba(0,210,255,0.1), transparent); padding-top:4px; padding-bottom:4px; border-radius:0 4px 4px 0;}
        .d-text { background: #1e293b; padding: 12px; border-radius: 6px; color: #cbd5e1; font-size: 13px; line-height: 1.7; white-space: pre-wrap; border: 1px solid #334155; text-align: justify; }

        /* â˜…â˜…â˜… æ–°å¢ï¼šäº§å“æœåŠ¡åˆ—è¡¨çš„ä¸“ç”¨æ ·å¼ â˜…â˜…â˜… */
        .ai-product-box ul { margin: 0; padding-left: 20px; color: #cbd5e1; font-size: 13px; line-height: 1.8; }
        .ai-product-box li { margin-bottom: 4px; }
        .ai-product-box li::marker { color: #52c41a; font-size: 10px; } /* ä½¿ç”¨ç»¿è‰²åœ†ç‚¹ */

        .star-box { display: flex; justify-content: space-between; background: #1e293b; padding: 15px; border-radius: 8px; border: 1px solid #334155; margin-bottom: 20px; }
        .star-col { text-align: center; }
        .star-val { font-size: 18px; color: #fbbf24; font-weight: bold; font-family: 'Arial'; }
        .star-label { font-size: 11px; color: #94a3b8; margin-top: 2px; }
    </style>
</head>
<body>

<div id="controls">
    <div class="ctrl-group">
        <div class="ctrl-title">ğŸ” äº§ä¸šé“¾æº¯æº</div>
        <div style="display:flex; gap:5px;">
            <input type="text" id="searchInput" placeholder="åç§° / ç¼–ç ">
            <button onclick="doSearch()" style="flex:1;">æœç´¢</button>
            <button onclick="clearSearch()" style="width:40px; background:#334155;">âŒ</button>
        </div>
        <div id="search-status">âš ï¸ æœç´¢é”å®šä¸­ (ç‚¹âŒé‡ç½®)</div>
    </div>
    <div class="ctrl-group">
        <div class="ctrl-title">ğŸ—ºï¸ å…¨å±€æ“ä½œ</div>
        <div class="btn-grid">
            <button class="action-btn" onclick="expandAll()">â¬ å®Œå…¨å±•å¼€</button>
            <button class="action-btn" onclick="collapseAll()">â« å®Œå…¨æŠ˜å </button>
        </div>
    </div>
    <div class="ctrl-group">
        <div class="ctrl-title">ğŸ”˜ å±‚çº§ç­›é€‰</div>
        <div class="btn-grid">
            <button onclick="switchLayer(1)" id="btn-1">1ï¸âƒ£ æºå¤´</button>
            <button onclick="switchLayer(2)" id="btn-2">2ï¸âƒ£ æ¿å—</button>
            <button onclick="switchLayer(3)" id="btn-3">3ï¸âƒ£ ç»†åˆ†</button>
            <button onclick="switchLayer(4)" id="btn-4">4ï¸âƒ£ ä¼ä¸š</button>
        </div>
        <button class="btn-full" onclick="switchLayer(5)" id="btn-5">5ï¸âƒ£ æ˜¾ç¤ºè¡—é•‡</button>
    </div>
    <div class="ctrl-group" style="border:none;">
        <div class="ctrl-title">ğŸ“Š æ•°é‡è¿‡æ»¤</div>
        <input type="range" id="rankSlider" min="1" max="100" value="10" oninput="updateSlider(this.value)">
        <div style="text-align:right; font-size:12px; color:#fbbf24; margin-top:5px;">Top <span id="sliderVal">10</span>%</div>
    </div>
</div>

<div id="details-panel">
    <button class="close-btn" onclick="$('#details-panel').fadeOut()">Ã—</button>
    <div id="d-content"></div>
</div>
<div id="main"></div>

<script>
    var myChart = echarts.init(document.getElementById('main'));
    var allNodes = [], allLinks = [];
    var expandedIds = new Set();
    var displayRatio = 0.1;
    var currentLevel = 2;
    var isSearchMode = false;
    var searchVisibleIds = new Set();
    var CFG = {
        colors: { 1: '#ff4d4f', 2: '#ffa940', 3: '#fadb14', 4: '#00d2ff', 5: '#52c41a' },
        sizes:  { 1: 50, 2: 35, 3: 20, 4: 8, 5: 5 },
        fixedPos: { 'ä¸Šæ¸¸': {x:0.5, y:0.05}, 'ä¸­æ¸¸': {x:0.5, y:0.50}, 'ä¸‹æ¸¸': {x:0.5, y:0.95} }
    };

    $(document).ready(function() {
        $.getJSON('/api/data', function(json) {
            allNodes = json.nodes; allLinks = json.links;
            var nodeMap = {}; allNodes.forEach(n => nodeMap[n.id] = n);
            allNodes.forEach(n => {
                n.pathIds = new Set(); var curr = n, safe = 0;
                while(curr && safe < 50) { n.pathIds.add(curr.id); curr = nodeMap[curr.parent]; safe++; }
            });
            switchLayer(2);
        });
    });

    function render() {
        var width = myChart.getWidth(), height = myChart.getHeight();
        var finalNodes = [], finalNodeIds = new Set();
        updateUI();
        
        console.log('å¼€å§‹æ¸²æŸ“ï¼Œæœç´¢æ¨¡å¼:', isSearchMode);
        console.log('æœç´¢å¯è§èŠ‚ç‚¹:', Array.from(searchVisibleIds));
        console.log('å±•å¼€çš„èŠ‚ç‚¹:', Array.from(expandedIds));
        
        allNodes.forEach(node => {
            var show = false;
            if (isSearchMode) {
                console.log('æ£€æŸ¥èŠ‚ç‚¹:', node.name, 'ID:', node.id, 'æ˜¯å¦åœ¨æœç´¢å¯è§èŠ‚ç‚¹ä¸­:', searchVisibleIds.has(node.id));
                if (searchVisibleIds.has(node.id)) {
                    show = true;
                    console.log('æ˜¾ç¤ºèŠ‚ç‚¹:', node.name, 'ID:', node.id);
                }
            }
            else {
                if (node.level === 1) show = true;
                else if (node.parent && expandedIds.has(node.parent)) show = true;
                if (show && node.level === 4) {
                    var limit = Math.ceil((node.details.total_siblings || 1) * displayRatio);
                    if ((node.details.rank || 999) > Math.max(limit, 1)) show = false;
                }
            }
            if (show) {
                finalNodeIds.add(node.id);
                var item = {
                    id: node.id, name: node.name, value: node.level,
                    symbolSize: CFG.sizes[node.level],
                    itemStyle: { color: CFG.colors[node.level], borderColor: '#fff', borderWidth: node.level===1?2:0, opacity: isSearchMode ? 1 : 0.95 },
                    label: { show: isSearchMode || (node.level <= 3 || (node.level===4 && finalNodeIds.size < 100)), position: node.level===5?'bottom':'right', formatter: node.level===5?'{b}':undefined, fontSize: node.level===1?14:10 },
                    rawData: node
                };
                if (CFG.fixedPos[node.name]) { item.x = width * CFG.fixedPos[node.name].x; item.y = height * CFG.fixedPos[node.name].y; item.fixed = true; }
                finalNodes.push(item);
            }
        });
        
        console.log('æœ€ç»ˆæ˜¾ç¤ºçš„èŠ‚ç‚¹:', finalNodes);
        
        var finalLinks = allLinks.filter(l => finalNodeIds.has(l.source) && finalNodeIds.has(l.target)).map(l => ({ source: l.source, target: l.target, lineStyle: { color: '#fff', opacity: isSearchMode?0.6:0.2, width: isSearchMode?2:1 } }));
        
        console.log('æœ€ç»ˆæ˜¾ç¤ºçš„é“¾æ¥:', finalLinks);
        
        myChart.setOption({ backgroundColor: '#0b0f19', series: [{ type: 'graph', layout: 'force', data: finalNodes, links: finalLinks, roam: true, force: { repulsion: 2000, gravity: 0.1, edgeLength: [60, 200], layoutAnimation: true } }] });
        
        console.log('æ¸²æŸ“å®Œæˆ');
    }

    window.expandAll = function() { if(isSearchMode)return; expandedIds.clear(); allNodes.forEach(n => { if (n.level < 4) expandedIds.add(n.id); }); currentLevel = 4; if (displayRatio < 0.2) { displayRatio = 0.2; $('#rankSlider').val(20); $('#sliderVal').text('20'); } render(); myChart.dispatchAction({ type: 'restore' }); };
    window.collapseAll = function() { if(isSearchMode)return; expandedIds.clear(); currentLevel = 1; render(); myChart.dispatchAction({ type: 'restore' }); };
    window.doSearch = function() { 
        var q = $('#searchInput').val().trim(); 
        if (!q) { 
            clearSearch(); 
            return; 
        } 
        console.log('æœç´¢å…³é”®è¯:', q);
        console.log('èŠ‚ç‚¹æ€»æ•°:', allNodes.length);
        
        // æ‰“å°å‰10ä¸ªèŠ‚ç‚¹çš„åç§°ï¼Œä»¥ä¾¿äº†è§£æ•°æ®æƒ…å†µ
        console.log('å‰10ä¸ªèŠ‚ç‚¹:', allNodes.slice(0, 10).map(n => n.name));
        
        // å°è¯•æ¨¡ç³Šæœç´¢ï¼Œä½¿ç”¨æ›´å®½æ¾çš„æ¡ä»¶
        var hits = allNodes.filter(n => 
            n.name.toLowerCase().indexOf(q.toLowerCase()) > -1 || 
            (n.details && n.details.code && String(n.details.code).toLowerCase().indexOf(q.toLowerCase()) > -1) ||
            (n.details && n.details.legal && String(n.details.legal).toLowerCase().indexOf(q.toLowerCase()) > -1)
        );
        
        console.log('æœç´¢ç»“æœ:', hits);
        
        if (hits.length === 0) { 
            // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ï¼Œå°è¯•æœç´¢åŒ…å«å…³é”®è¯çš„ä»»æ„éƒ¨åˆ†
            var partialHits = allNodes.filter(n => 
                q.toLowerCase().split(' ').some(word => 
                    n.name.toLowerCase().indexOf(word) > -1
                )
            );
            
            console.log('éƒ¨åˆ†åŒ¹é…ç»“æœ:', partialHits);
            
            if (partialHits.length === 0) {
                alert("æœªæ‰¾åˆ°"); 
                return;
            } else {
                hits = partialHits;
            }
        } 
        
        searchVisibleIds.clear(); 
        hits.forEach(h => {
            console.log('æ‰¾åˆ°èŠ‚ç‚¹:', h.name, 'ID:', h.id);
            console.log('èŠ‚ç‚¹è·¯å¾„:', Array.from(h.pathIds));
            h.pathIds.forEach(id => searchVisibleIds.add(id));
        });
        
        console.log('æœç´¢å¯è§èŠ‚ç‚¹:', Array.from(searchVisibleIds));
        
        isSearchMode = true; 
        
        // å¼ºåˆ¶è§¦å‘ç•Œé¢æ›´æ–°
        setTimeout(function() {
            render(); 
            // å¼ºåˆ¶EChartsé‡ç»˜
            myChart.resize();
            myChart.dispatchAction({ type: 'restore' }); 
        }, 100);
    };
    window.clearSearch = function() { $('#searchInput').val(''); isSearchMode = false; switchLayer(currentLevel); };
    window.switchLayer = function(lvl) { 
        if (isSearchMode) return; 
        console.log('åˆ‡æ¢å±‚çº§:', lvl);
        currentLevel = lvl; 
        expandedIds.clear(); 
        
        // å±•å¼€æ‰€æœ‰å°äºå½“å‰å±‚çº§çš„èŠ‚ç‚¹
        allNodes.forEach(n => { 
            if (n.level < lvl) { 
                expandedIds.add(n.id);
                console.log('å±•å¼€èŠ‚ç‚¹:', n.name, 'å±‚çº§:', n.level);
            }
        }); 
        
        console.log('å±•å¼€çš„èŠ‚ç‚¹æ€»æ•°:', expandedIds.size);
        
        // ç‰¹åˆ«å¤„ç†å±‚çº§3çš„æƒ…å†µï¼Œç¡®ä¿å±•å¼€æ‰€æœ‰å±‚çº§ä¸º2çš„èŠ‚ç‚¹
        if (lvl === 3) {
            console.log('å¤„ç†å±‚çº§3çš„æƒ…å†µ');
            allNodes.forEach(n => {
                if (n.level === 2) {
                    expandedIds.add(n.id);
                    console.log('é¢å¤–å±•å¼€èŠ‚ç‚¹:', n.name, 'å±‚çº§:', n.level);
                }
            });
            console.log('å¤„ç†åå±•å¼€çš„èŠ‚ç‚¹æ€»æ•°:', expandedIds.size);
        }
        
        if (lvl >= 4 && displayRatio < 0.2) { 
            displayRatio = 0.2; 
            $('#rankSlider').val(20); 
            $('#sliderVal').text('20'); 
        } 
        
        // å¼ºåˆ¶è§¦å‘ç•Œé¢æ›´æ–°
        setTimeout(function() {
            render(); 
            // å¼ºåˆ¶EChartsé‡ç»˜
            myChart.resize();
            if (lvl <= 3) myChart.dispatchAction({ type: 'restore' }); 
        }, 100);
    };

    myChart.on('click', function(params) {
        if (params.dataType === 'node') {
            var node = params.data.rawData;
            if (!isSearchMode && node.level < 5) {
                if (expandedIds.has(node.id)) expandedIds.delete(node.id); else expandedIds.add(node.id);
                render();
            }
            showDetails(node);
        }
    });

    // â˜…â˜…â˜… æ ¸å¿ƒï¼šè¯¦æƒ…å±•ç¤ºé€»è¾‘ â˜…â˜…â˜…
    function showDetails(node) {
        var d = node.details || {};
        var html = `<div class="d-header"><div class="d-name">${node.name}</div>`;

        if (node.level === 4) {
            html += `<div class="code-wrapper"><div class="code-box"><div class="d-code">${d.code}</div><div class="d-code-desc">ä¼ä¸šå”¯ä¸€è¯†åˆ«ç </div></div></div>`;
            html += `</div><div class="d-body">`;

            // 1. æ ‡ç­¾
            if (d.tags && d.tags !== 'nan' && d.tags.length > 0) {
                html += `<div class="tag-cloud">`;
                d.tags.split(',').forEach(t => { if(t && t.length > 1) html += `<span class="tag">${t}</span>`; });
                html += `</div>`;
            }

            // 2. è¯„åˆ†
            function renderStars(score) {
                let stars = '';
                for (let i = 1; i <= 5; i++) {
                    stars += i <= score ? 'â˜…' : 'â˜†';
                }
                return stars;
            }
            html += `<div class="star-box">
                <div class="star-col"><div class="star-val">${renderStars(d.stars)}</div><div class="star-label">ç»¼åˆæŒ‡æ•°</div></div>
                <div class="star-col"><div class="star-val" style="color:#22d3ee">${renderStars(d.star_tech)}</div><div class="star-label">ç§‘æŠ€åˆ›æ–°</div></div>
                <div class="star-col"><div class="star-val" style="color:#52c41a">${renderStars(d.star_str)}</div><div class="star-label">ä¼ä¸šå®åŠ›</div></div>
            </div>`;

            // 3. åŸºç¡€ä¿¡æ¯
            html += `<div class="info-list">
                ${makeRow('æ³•äººä»£è¡¨', d.legal)}
                ${makeRow('æ³¨å†Œèµ„æœ¬', d.capital ? d.capital + ' ä¸‡å…ƒ' : '')}
                ${makeRow('æˆç«‹æ—¥æœŸ', (d.date||'').replace('00:00:00',''))}
                ${makeRow('è”ç³»æ–¹å¼', d.contact)}
                ${makeRow('æ³¨å†Œ/ç»è¥åœ°', d.address)}
                ${makeRow('å‚ä¿äººæ•°', d.insured)}
                ${makeRow('ä¼ä¸šç±»å‹', d.company_type)}
            </div>`;

            // 4. è¡Œä¸šä¿¡æ¯
            html += `<div class="info-list">
                ${makeRow('ä¸Šä¸­ä¸‹æ¸¸', d.industry_stream)}
                ${makeRow('ç»†åˆ†å°ç±»', d.sub_category)}
                ${makeRow('ç½®ä¿¡åº¦', d.confidence ? (d.confidence * 100).toFixed(1) + '%' : '')}
            </div>`;

            // 4. æ ¸å¿ƒæŠ€æœ¯/äº§å“/æœåŠ¡
            if (hasText(d.product_services)) {
                html += `<div class="section-box ai-product-box">
                            <div class="section-title">ğŸ æ ¸å¿ƒæŠ€æœ¯/äº§å“/æœåŠ¡</div>
                            <div class="d-text">${formatList(d.product_services)}</div>
                         </div>`;
            } else if (hasText(d.tech_text)) {
                html += `<div class="section-box">
                            <div class="section-title">ğŸ æ ¸å¿ƒæŠ€æœ¯/äº§å“/æœåŠ¡</div>
                            <div class="d-text">${formatList(d.tech_text)}</div>
                         </div>`;
            }

            // 5. ä¸»è¦åº”ç”¨åœºæ™¯
            if (hasText(d.scene_text)) {
                html += `<div class="section-box">
                            <div class="section-title">ğŸ™ï¸ ä¸»è¦åº”ç”¨åœºæ™¯</div>
                            <div class="d-text">${formatList(d.scene_text)}</div>
                         </div>`;
            }

            // 6. å…¶ä»–æ–‡æœ¬
            if (hasText(d.intro) && d.intro !== 'æš‚æ— ç®€ä»‹') {
                html += `<div class="section-box"><div class="section-title">ğŸ“ ä¼ä¸šç®€ä»‹</div><div class="d-text">${d.intro}</div></div>`;
            }

        } else if (node.level === 5) {
            html += `</div><div class="d-body"><div class="d-text" style="color:#52c41a; text-align:center;">ã€è¡—é•‡æ±‡èšèŠ‚ç‚¹ã€‘</div></div>`;
        } else {
            html += `</div><div class="d-body"><div style="color:#888; text-align:center; padding:20px;">ç‚¹å‡»ä¸‹çº§èŠ‚ç‚¹æŸ¥çœ‹è¯¦æƒ…</div></div>`;
        }

        $('#d-content').html(html);
        $('#details-panel').fadeIn();
    }

    function makeRow(key, val) {
        var v = (val && val !== 'nan' && val !== 'null') ? val : '-';
        if (v === '-') return '';
        return `<div class="info-row"><div class="info-k">${key}</div><div class="info-v ${key==='æ³•äººä»£è¡¨'?'highlight':''}">${v}</div></div>`;
    }
    function hasText(txt) { return txt && txt !== 'nan' && txt !== 'null' && txt !== '-' && txt.length > 2; }
    
    function formatList(text) {
        if (!text) return '';
        // å¦‚æœå·²ç»æ˜¯HTMLåˆ—è¡¨ï¼Œç›´æ¥è¿”å›
        if (text.includes('<ul>') || text.includes('<ol>')) {
            return text;
        }
        // æŒ‰åˆ†å·ã€é€—å·ã€å¥å·ç­‰åˆ†éš”ç¬¦åˆ†å‰²æ–‡æœ¬
        let items = text.split(/[ï¼›;ï¼Œ,ã€‚.]+/).filter(item => item.trim().length > 0);
        // å¦‚æœæ²¡æœ‰åˆ†å‰²å‡ºå¤šä¸ªé¡¹ï¼Œå°è¯•æŒ‰æ•°å­—åºå·åˆ†å‰²
        if (items.length === 1) {
            items = text.split(/\d+\.\s*/).filter(item => item.trim().length > 0);
        }
        // å¦‚æœè¿˜æ˜¯æ²¡æœ‰åˆ†å‰²å‡ºå¤šä¸ªé¡¹ï¼Œå°è¯•æŒ‰æ¢è¡Œç¬¦åˆ†å‰²
        if (items.length === 1) {
            items = text.split(/\n+/).filter(item => item.trim().length > 0);
        }
        // ç”Ÿæˆå¸¦åºå·çš„åˆ—è¡¨
        let result = '';
        items.forEach((item, index) => {
            result += `${index + 1}. ${item.trim()}\n`;
        });
        return result;
    }
    function updateUI() { if (isSearchMode) { $('.btn-grid button, #btn-5, .action-btn').addClass('disabled'); $('#search-status').show(); } else { $('.btn-grid button, #btn-5, .action-btn').removeClass('disabled'); $('#search-status').hide(); for(let i=1;i<=5;i++) $(`#btn-${i}`).toggleClass('active', i===currentLevel); } }
    window.updateSlider = function(v) { displayRatio = v/100.0; $('#sliderVal').text(v); render(); };
    $('#searchInput').on('keypress', function(e) { if(e.which==13) doSearch(); });
    window.onresize = function() { myChart.resize(); render(); };
</script>
</body>
</html>